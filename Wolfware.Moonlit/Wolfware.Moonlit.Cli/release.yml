name: "Test Release"

plugins:
  - name: "gh"
    url: "file://D:/wolfware/moonlit/Wolfware.Moonlit/Wolfware.Moonlit.Plugins.GitHub/bin/Debug/net9.0/Wolfware.Moonlit.Plugins.Github.dll"
    config:
      token: $(GITHUB_TOKEN)
  - name: "sr"
    url: "file://D:/wolfware/moonlit/Wolfware.Moonlit/Wolfware.Moonlit.Plugins.SemanticRelease/bin/Debug/net9.0/Wolfware.Moonlit.Plugins.SemanticRelease.dll"

stages:
  analyze:
    - name: repo
      run: gh.repo-context
    - name: tag
      run: gh.latest-tag
      config:
        tag: "v[0-9]+.[0-9]+.[0-9]+"
    - name: items
      run: gh.items-since-tag
      config:
        tag: $(output:tag:name)
    - name: version
      run: sr.calculate-version
      config:
        branch: $(output:repo:branch)
        baseVersion: $(output:tag:name)
        commits: $(output:items:commits)
        prereleaseMappings:
          main: next
    - name: changelog
      run: sr.generate-changelog
      config:
        commits: $(output:items:commits)
        openAiKey: $(OPENAI_API_KEY)

  release:
    - name: createRelease
      run: gh.create-release
      config:
        name: "Release $(output:calculateVersion:nextVersion)"
        tag: $(output:version:nextVersion)
        changelog: $(output:changelog:entries)
        draft: true
        prerelease: $(output:calculateVersion:isPrerelease)

#  notify:
#    - name: "github.create-issue"
#      config:
#        context: "test"
#        title: "Release @{{analyze.version}}"
#        body: "A new release has been created with version @{{analyze.version}}.\n\nChangelog:\n@{analyze.changelog}"
#        labels: [ "release", "notification" ]
#        assignees: [ "@{GIT_REPOSITORY}" ]